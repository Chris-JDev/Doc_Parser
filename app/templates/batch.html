{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Processing {{ jobs|length }} Documents</h1>
</div>

<div class="batch-container">
    <div class="batch-summary" id="batchSummary">
        <div class="summary-stats">
            <div class="stat">
                <span class="stat-value" id="completedCount">0</span>
                <span class="stat-label">Completed</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="processingCount">0</span>
                <span class="stat-label">Processing</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="pendingCount">{{ jobs|length }}</span>
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="failedCount">0</span>
                <span class="stat-label">Failed</span>
            </div>
        </div>
        <div class="batch-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="batchProgress" style="width: 0%"></div>
            </div>
            <div class="batch-time-info">
                <span id="elapsedTime">Elapsed: 0s</span>
                <span id="estimatedTime" style="display: none;">Est. remaining: Calculating...</span>
            </div>
        </div>
    </div>
    
    <div class="jobs-list">
        {% for job in jobs %}
        <div class="job-card" id="job-{{ job.id }}" data-status="{{ job.status }}">
            <div class="job-icon" id="icon-{{ job.id }}">‚è≥</div>
            <div class="job-info">
                <div class="job-filename">{{ job.filename }}</div>
                <div class="job-status" id="status-{{ job.id }}">{{ job.status }}</div>
            </div>
            <div class="job-invoices" id="invoices-{{ job.id }}" style="display: none;">
                <span class="invoice-count">0 invoices</span>
            </div>
            <div class="job-actions">
                <a href="/docs/{{ job.document_id }}" class="btn btn-sm btn-outline view-btn" id="view-{{ job.id }}" style="display: none;">View</a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="batch-actions" id="batchActions" style="display: none;">
        <a href="/" class="btn btn-primary">View All in Dashboard</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const jobIds = {{ job_ids | tojson }};
const jobs = {};
let eventSources = {};
let startTime = Date.now();
let timerInterval = null;
let completedJobs = 0;
let jobTimes = [];  // Track completion time per job

// Start timer
function startTimer() {
    timerInterval = setInterval(() => {
        updateTimeDisplay();
    }, 1000);
}

function formatDuration(seconds) {
    if (seconds < 60) return seconds + 's';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return mins + 'm ' + secs + 's';
}

function updateTimeDisplay() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('elapsedTime').textContent = 'Elapsed: ' + formatDuration(elapsed);
    
    // Calculate estimate
    if (completedJobs > 0 && completedJobs < jobIds.length) {
        const estimatedDiv = document.getElementById('estimatedTime');
        estimatedDiv.style.display = 'inline';
        
        const avgTimePerJob = elapsed / completedJobs;
        const remainingJobs = jobIds.length - completedJobs;
        const estimatedRemaining = Math.ceil(avgTimePerJob * remainingJobs);
        
        estimatedDiv.textContent = 'Est. remaining: ' + formatDuration(estimatedRemaining);
    }
}

// Initialize jobs
jobIds.forEach(id => {
    jobs[id] = { status: 'queued', invoiceCount: 0 };
});

startTimer();

// Update UI
function updateUI() {
    let completed = 0, processing = 0, pending = 0, failed = 0;
    
    for (const id of jobIds) {
        const job = jobs[id];
        const card = document.getElementById('job-' + id);
        const icon = document.getElementById('icon-' + id);
        const status = document.getElementById('status-' + id);
        const viewBtn = document.getElementById('view-' + id);
        const invoices = document.getElementById('invoices-' + id);
        
        switch (job.status) {
            case 'queued':
                icon.textContent = '‚è≥';
                pending++;
                break;
            case 'processing':
            case 'converting':
            case 'extracting':
            case 'translating':
            case 'structuring':
                icon.textContent = 'üîÑ';
                card.classList.add('processing');
                processing++;
                break;
            case 'done':
                icon.textContent = '‚úÖ';
                card.classList.remove('processing');
                card.classList.add('done');
                viewBtn.style.display = 'inline-block';
                if (job.invoiceCount > 0) {
                    invoices.style.display = 'block';
                    invoices.querySelector('.invoice-count').textContent = 
                        job.invoiceCount + ' invoice' + (job.invoiceCount > 1 ? 's' : '');
                }
                completed++;
                break;
            case 'failed':
                icon.textContent = '‚ùå';
                card.classList.remove('processing');
                card.classList.add('failed');
                viewBtn.style.display = 'inline-block';
                failed++;
                break;
            case 'canceled':
                icon.textContent = 'üö´';
                card.classList.remove('processing');
                card.classList.add('canceled');
                failed++;
                break;
        }
        
        status.textContent = job.status;
    }
    
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('processingCount').textContent = processing;
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('failedCount').textContent = failed;
    
    const progress = Math.round((completed + failed) / jobIds.length * 100);
    document.getElementById('batchProgress').style.width = progress + '%';
    
    // Show actions when all done
    if (completed + failed === jobIds.length) {
        document.getElementById('batchActions').style.display = 'block';
    }
}

// Connect to SSE for each job
function connectJob(jobId) {
    const eventSource = new EventSource(`/api/jobs/${jobId}/events`);
    eventSources[jobId] = eventSource;
    
    eventSource.addEventListener('status', (e) => {
        const data = JSON.parse(e.data);
        jobs[jobId].status = data.status;
        updateUI();
    });
    
    eventSource.addEventListener('done', (e) => {
        const data = JSON.parse(e.data);
        jobs[jobId].status = 'done';
        jobs[jobId].invoiceCount = data.invoice_count || 1;
        eventSource.close();
        completedJobs++;  // Track for time estimate
        updateUI();
    });
    
    eventSource.addEventListener('error', (e) => {
        if (e.data) {
            const data = JSON.parse(e.data);
            jobs[jobId].status = 'failed';
        }
        eventSource.close();
        completedJobs++;  // Count failed as completed for estimate
        updateUI();
    });
    
    eventSource.addEventListener('canceled', (e) => {
        jobs[jobId].status = 'canceled';
        eventSource.close();
        completedJobs++;  // Count canceled as completed for estimate
        updateUI();
    });
    
    eventSource.onerror = () => {
        // Check if already done
        if (!['done', 'failed', 'canceled'].includes(jobs[jobId].status)) {
            // Reconnect or mark as unknown
            setTimeout(() => {
                if (!['done', 'failed', 'canceled'].includes(jobs[jobId].status)) {
                    connectJob(jobId);
                }
            }, 2000);
        }
    };
}

// Start connections
jobIds.forEach(connectJob);
updateUI();
</script>

<style>
.batch-container {
    max-width: 800px;
    margin: 0 auto;
}

.batch-summary {
    background: var(--surface);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
}

.stat {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.batch-progress {
    margin-top: 1rem;
}

.jobs-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.job-card {
    background: var(--surface);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
}

.job-card.processing {
    border-left: 3px solid var(--primary-color);
}

.job-card.done {
    border-left: 3px solid var(--success-color);
}

.job-card.failed, .job-card.canceled {
    border-left: 3px solid var(--danger-color);
}

.job-icon {
    font-size: 1.5rem;
}

.job-info {
    flex: 1;
}

.job-filename {
    font-weight: 500;
}

.job-status {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-transform: capitalize;
}

.job-invoices {
    background: var(--background);
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
}

.batch-actions {
    margin-top: 2rem;
    text-align: center;
}
</style>
{% endblock %}
